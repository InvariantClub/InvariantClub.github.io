<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Packaging 128 languages with Nix | Invariant Club</title>
    <meta name="description" content="Reaching development nirvana through Nix">
    <meta name="generator" content="VitePress v1.0.0-rc.35">
    <link rel="preload stylesheet" href="/assets/style.Hz6tFr74.css" as="style">
    
    <script type="module" src="/assets/app.lySqW1Jl.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.bvIUbFQP.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.XjU3QN70.js">
    <link rel="modulepreload" href="/assets/chunks/theme.qNbr_XGW.js">
    <link rel="modulepreload" href="/assets/articles_packaging-128-programming-languages-with-nix.md.sje4CVhI.lean.js">
    <link rel="stylesheet" href="//fonts.googleapis.com/css2?family=Fira+Code&amp;family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&amp;display=swap">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-9d8abc1e><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-9d8abc1e data-v-7ad780c2><div class="VPNavBar has-sidebar" data-v-7ad780c2 data-v-3efcd581><div class="wrapper" data-v-3efcd581><div class="container" data-v-3efcd581><div class="title" data-v-3efcd581><div class="VPNavBarTitle has-sidebar" data-v-3efcd581 data-v-e4cade88><a class="title" href="/" data-v-e4cade88><!--[--><!--]--><!----><!--[-->Invariant Club<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-3efcd581><div class="content-body" data-v-3efcd581><!--[--><!--]--><div class="VPNavBarSearch search" data-v-3efcd581><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-3efcd581 data-v-f732b5d0><span id="main-nav-aria-label" class="visually-hidden" data-v-f732b5d0>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/articles.html" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>Articles</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/templates/" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>Templates</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/faqs.html" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>FAQs</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-3efcd581 data-v-283b26e9><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-283b26e9 data-v-d80abb8e data-v-1c29e291><span class="check" data-v-1c29e291><span class="icon" data-v-1c29e291><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-d80abb8e><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-d80abb8e><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-3efcd581 data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/InvariantClub/" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-16cf740a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-3efcd581 data-v-8e87c032 data-v-aa8de344><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-aa8de344><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-aa8de344><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-aa8de344><div class="VPMenu" data-v-aa8de344 data-v-e42ed9b3><!----><!--[--><!--[--><!----><div class="group" data-v-8e87c032><div class="item appearance" data-v-8e87c032><p class="label" data-v-8e87c032>Appearance</p><div class="appearance-action" data-v-8e87c032><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-8e87c032 data-v-d80abb8e data-v-1c29e291><span class="check" data-v-1c29e291><span class="icon" data-v-1c29e291><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-d80abb8e><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-d80abb8e><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-8e87c032><div class="item social-links" data-v-8e87c032><div class="VPSocialLinks social-links-list" data-v-8e87c032 data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/InvariantClub/" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-16cf740a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-3efcd581 data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-3efcd581><div class="divider-line" data-v-3efcd581></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-9d8abc1e data-v-b979e4d9><div class="container" data-v-b979e4d9><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-b979e4d9><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-b979e4d9><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-b979e4d9>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-b979e4d9 data-v-2744f6e0><button data-v-2744f6e0>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-9d8abc1e data-v-4871f9f5><div class="curtain" data-v-4871f9f5></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-4871f9f5><span class="visually-hidden" id="sidebar-aria-label" data-v-4871f9f5> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-4871f9f5><section class="VPSidebarItem level-0" data-v-4871f9f5 data-v-bd01e0d5><div class="item" role="button" tabindex="0" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><h2 class="text" data-v-bd01e0d5>Resources</h2><!----></div><div class="items" data-v-bd01e0d5><!--[--><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/articles.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Articles</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/templates/" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Templates</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/faqs.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>FAQs</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-9d8abc1e data-v-3cf691b6><div class="VPDoc has-sidebar has-aside" data-v-3cf691b6 data-v-4e39c852><!--[--><!--]--><div class="container" data-v-4e39c852><div class="aside" data-v-4e39c852><div class="aside-curtain" data-v-4e39c852></div><div class="aside-container" data-v-4e39c852><div class="aside-content" data-v-4e39c852><div class="VPDocAside" data-v-4e39c852 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-cb998dce data-v-6b52fe58><div class="content" data-v-6b52fe58><div class="outline-marker" data-v-6b52fe58></div><div class="outline-title" role="heading" aria-level="2" data-v-6b52fe58>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-6b52fe58><span class="visually-hidden" id="doc-outline-aria-label" data-v-6b52fe58> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-6b52fe58 data-v-53c99d69><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-4e39c852><div class="content-container" data-v-4e39c852><!--[--><!--]--><main class="main" data-v-4e39c852><div style="position:relative;" class="vp-doc _articles_packaging-128-programming-languages-with-nix" data-v-4e39c852><div><!--[--><h1>Packaging 128 languages with Nix</h1><small class="author-info"><img width="50" src="/images/noon.png"> by Noon van der Silk</small><!--]--><p><img src="/images/quine-relay-128.png" alt="Quine relay logo: 128 languages"><small> Image credit: @mame&#39;s <a href="https://github.com/mame/quine-relay" target="_blank" rel="noreferrer">quine-relay</a> project. </small></p><hr><p>The famous <a href="https://github.com/mame/quine-relay" target="_blank" rel="noreferrer">quine-relay</a> by <a href="https://github.com/mame" target="_blank" rel="noreferrer">@mame</a> project builds a so-called &quot;uroboros&quot; <a href="https://en.wikipedia.org/wiki/Quine_(computing)" target="_blank" rel="noreferrer">quine</a> through 128 languages; i.e. from ruby to rust to scala to guile to .... all the way back to ruby again, where the final output ruby program is exactly equal to the original ruby program.</p><p>Clearly, this is an awesome achievement!</p><p>But, have you tried to run it yourself? If you have, you might have found it hard to reproduce. As of the time of writing, the Docker build fails. I don&#39;t run Ubuntu, so I can&#39;t tell if all the apt-get install commands work; maybe they do, but maybe not.</p><p>So, there&#39;s a natural idea. Indeed, one that <a href="https://github.com/NixOS/nixpkgs/issues/131492" target="_blank" rel="noreferrer">someone else had all the way back in 2021</a>. What if we package it with Nix? Then we can get a simple invocation, <code>nix build ...</code> that will produce the final output.</p><p>This seemed like a fun challenge, and a good test for Nix: Would we be able to do it? And if so, at what cost?</p><p>Let&#39;s get into it.</p><h3 id="can-we-do-it" tabindex="-1">Can we do it? <a class="header-anchor" href="#can-we-do-it" aria-label="Permalink to &quot;Can we do it?&quot;">‚Äã</a></h3><p>Even before getting started, we know the answer to this: Yes. The <a href="https://github.com/mame/quine-relay/wiki/Language-inclusion-criteria" target="_blank" rel="noreferrer">premise of including a particular language</a> is that it should either be available in Ubuntu, or otherwise expressible as a simple ruby program.</p><p>So that&#39;s simple: it can definitely be done. If it can be built for Ubuntu, we can either see if it&#39;s already on <a href="https://search.nixos.org/packages" target="_blank" rel="noreferrer">nixpkgs</a>, and if not, work out how to build it from source.</p><p>Motivation high; it&#39;s now down to our willingness to do a bunch of hacking. Let&#39;s get started.</p><h3 id="how-did-we-do-it" tabindex="-1">How did we do it? <a class="header-anchor" href="#how-did-we-do-it" aria-label="Permalink to &quot;How did we do it?&quot;">‚Äã</a></h3><p>Given the large package set already available through nixpkgs, the task <em>should</em> be pretty simple, and can be broken into two parts:</p><ul><li>Those already in Nix,</li><li>Those we have to manually package.</li></ul><h4 id="languages-already-in-nix" tabindex="-1">Languages already in Nix <a class="header-anchor" href="#languages-already-in-nix" aria-label="Permalink to &quot;Languages already in Nix&quot;">‚Äã</a></h4><p>Luckly, a large portion of the languages we needed were already packaged in Nix.</p><p>Those were: ruby, rust, scala, guile, scilab, sed, slang, standard-ml, surgescript, swift, tcl, tc, typescript, vala, verilog, vim, vb, wasm, xslt, yab, zsh, ada, algol, aspectj, asymptote, ats, awk, bash, bc, beanshell, c, cpp, csharp, clojure, cmake, cobol, coffeescript, clisp, crystal, d, dhall, elixir, elisp, erlang, execline, fsharp, flex, fish, forth, fortran77, fortran90, gap, gdb, gnuplot, go, golfscript, groovy, gzip, haskell, haxe, icon, jasmine, java, javascript, jq, kotlin, ksh, llvm, lolcode, lua, m4, make, minizinc, modula2 (almost), msil, mustache, nasm, neko, nim, objectivec, ocaml, octave, pari, pascal, perl5, perl6 (raku), php, pike, postscript, prolog, spin, python, r, rc, rexx, (and ruby again!)</p><p>This is actually almost all of them: 95 languages. That leaves in principle 33 languages we have to do something a little more complicated for; in practice it&#39;s fewer as <a href="https://github.com/mame/" target="_blank" rel="noreferrer">mame</a> has ruby versions of interpreters for a few of the more esoteric languages.</p><p>Our approach for languages <em>already</em> in Nix was to just write a bunch of expressions ultimately of this form:</p><div class="language-nix vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nix</span><pre class="shiki shiki-themes min-light nord vp-code"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">with</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> pkgs</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">; </span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">runCommand</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">QR.rs</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;">  nativeBuildInputs</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> [</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> rust</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> ]</span><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">rustc QR.rs</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">./QR &gt; QR.scala</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&#39;&#39;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Only some minor changes to make each subsequent step depend on the derivation output of the prior one, so it becomes:</p><div class="language-nix vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nix</span><pre class="shiki shiki-themes min-light nord vp-code"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">ruby-to-rust</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> =</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">rust-to-scala</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> with</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> pkgs</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> runCommand</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">QR.rs</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;">    nativeBuildInputs</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> [</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> rust</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> ]</span><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">  }</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &#39;&#39;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">  rustc </span><span style="--shiki-light:#22863A;--shiki-dark:#81A1C1;">${</span><span style="--shiki-light:#22863A;--shiki-dark:#D8DEE9;">ruby-to-rust</span><span style="--shiki-light:#22863A;--shiki-dark:#81A1C1;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;"> -o QR</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">  ./QR &gt; $out</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">  &#39;&#39;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>This basic format will actually serve for every step. The only question is how we get the necessary compilers/interpreters for the languages that aren&#39;t present.</p><h3 id="languages-we-had-to-manually-package" tabindex="-1">Languages we had to manually package <a class="header-anchor" href="#languages-we-had-to-manually-package" aria-label="Permalink to &quot;Languages we had to manually package&quot;">‚Äã</a></h3><p>For all but a few, the approach was this:</p><ol><li>Find the source code,</li><li>Clone it,</li><li>Try and build it with Nix,</li><li>If that works, great!</li></ol><p>With a little hacking here and there, adding in necessary build-time dependencies, this worked for basically all the languages aside from <em>gambas3</em> and <em>modula-2</em>.</p><p>These two proved difficult for some kind-of interesting reasons.</p><h5 id="gambas3" tabindex="-1">gambas3 <a class="header-anchor" href="#gambas3" aria-label="Permalink to &quot;gambas3&quot;">‚Äã</a></h5><p><a href="https://gambaswiki.org/wiki" target="_blank" rel="noreferrer">Gambas</a> is a basic-like programming language. If you follow the expected process and just try and build it (after adding the necessary dependencies) you would find that it fails at runtime.</p><p>Glancing around the sourcecode, you can find that there is a large number of references to <code>/usr/lib/...</code>. If you use <a href="https://nixos.org/" target="_blank" rel="noreferrer">NixOS</a>, you will spot this as an immediate issue. If some program is explicitly expecting these paths to exist, they will be disappointed with prejudice.</p><p>The solution is to make use of the <code>buildFHSEnv</code> function which creates a runtime environment for packages like that to execute in.</p><h5 id="modula-2" tabindex="-1">modula-2 <a class="header-anchor" href="#modula-2" aria-label="Permalink to &quot;modula-2&quot;">‚Äã</a></h5><p>This one was a bit of a personal journey in learning a little bit more about Nix.</p><p>If you try and trackdown where the modula-2 sourcecode is, you find it&#39;s in <a href="https://gcc.gnu.org/" target="_blank" rel="noreferrer">&quot;gcc&quot;</a> - the GNU compiler collection.</p><p>Great news!</p><p>In fact, that library is actually already an essential part of nixpkgs: <a href="https://ryantm.github.io/nixpkgs/stdenv/stdenv/" target="_blank" rel="noreferrer">stdenv</a>, and is just a simple package on nixpkgs: <a href="https://search.nixos.org/packages?channel=25.11&amp;query=gcc" target="_blank" rel="noreferrer">gcc on nixpkgs</a>.</p><p>But, if you glance at the source code for that derivation, it&#39;s quite complicated. And taking a look around, you can see that there&#39;s a place where different languages are configured: <a href="https://github.com/NixOS/nixpkgs/blob/nixos-25.11/pkgs/development/compilers/gcc/common/configure-flags.nix#L210" target="_blank" rel="noreferrer">configure-flags.nix</a>, but <code>m2</code> is missing as an option.</p><p>At this point, I tried to make a patch to nixpkgs directly to add it. For whatever reason, it didn&#39;t work, and I discarded that idea.</p><p>Next, I tried to build <em>just</em> the m2 part of the <a href="https://github.com/gcc-mirror/gcc" target="_blank" rel="noreferrer">gcc codebase</a> &quot;manually&quot;; i.e. by writing by a Nix derivation that was &quot;good enough&quot;. This was a mistake. The main complaint I want to make here is against monorepos. It&#39;s surprisingly hard to just isolate a small part that you want to build, even in an only-moderately complicated codebase, let alone one like gcc. I kept running into problems that were clearly addressed by all the code in nixpkgs; but I didn&#39;t want to have to spend hours trying to work out all those details.</p><p>In the end I actually found a <em>different</em> implementation of modula-2 in <a href="https://github.com/davidgiven/ack" target="_blank" rel="noreferrer">ack</a>; and used that (briefly). This did work, and for me just highlights the benefits of smaller isolated repositories: easier to build only the thing you care about.</p><p>In the end I actually did come back to gcc&#39;s m2 through an elegant approach by <a href="https://github.com/SandaruKasa/quine-relay/blob/nix/nix/gm2.nix#L13" target="_blank" rel="noreferrer">SandaruKasa</a> (more on Sandaru in a moment); namely, to just use the <code>overrideAttrs</code> capability to enable m2. This then works perfectly!</p><p>It was done! I could run <code>nix build</code> and get a resulting <code>QR.rb</code> file that was exactly equal to the original! üéâ</p><h3 id="surprise-conclusion" tabindex="-1">Surprise conclusion ? <a class="header-anchor" href="#surprise-conclusion" aria-label="Permalink to &quot;Surprise conclusion ?&quot;">‚Äã</a></h3><p>So I did this, and submitted my PR and it was diligently accepted? And I basked in my own brilliance and unique ability to achieve this personal goal? Not exactly.</p><p>Before I started this, I was a good citizen and I searched the PRs on the repo to see if anyone had tried; there were no results. In fact there were no open PRs at all. So fine, I rolled up my sleeves and got to work.</p><p>After a few late evenings of hacking, I was ready to <a href="https://github.com/mame/quine-relay/pull/163" target="_blank" rel="noreferrer">write up my PR</a>). As I was writing, I half-noticed that there was one open PR; &quot;oh&quot; I thought, &quot;that&#39;s interesting, I&#39;ll have a look in a moment&quot;. I typed up my thoughts, and submitted.</p><p>I sat back, and waited for the love to roll in. &quot;May as well see what that PR is about&quot; I thought. <a href="https://github.com/mame/quine-relay/pull/162" target="_blank" rel="noreferrer">I clicked it</a>, and found ...</p><p><img src="/images/blog/sandaru-pr.webp" alt="Sandaru&#39;s Nix PR"></p><p>üò≤ ü§Ø !</p><p><a href="https://github.com/SandaruKasa" target="_blank" rel="noreferrer">@SandaruKasa</a> had the exact same idea as me at basically the exact same time, and submitted their PR a few days before me!</p><p>I started taking a close look. Sandaru resolved many similar problems to me; often in a more elegant way. Both our approaches <a href="https://github.com/mame/quine-relay/pull/162#issuecomment-3809480520" target="_blank" rel="noreferrer">worked</a>, and indeed we could both take interesting ideas from each others approach.</p><p>I was actually quite excited by this. First, I was very happy to learn from Sandaru, and have since refactored and improved my approach. Secondly, it also demonstrates the &quot;ease&quot; of packaging things with Nix: there was nothing unique that was required; merely dedication to getting it done. There wasn&#39;t only one magic solution to discover; it was possible to achieve the outcome in a variety of ways!</p><p>For me this is the best possible outcome.</p><h2 id="appendix" tabindex="-1">Appendix <a class="header-anchor" href="#appendix" aria-label="Permalink to &quot;Appendix&quot;">‚Äã</a></h2><h3 id="lessons-learned" tabindex="-1">Lessons learned <a class="header-anchor" href="#lessons-learned" aria-label="Permalink to &quot;Lessons learned&quot;">‚Äã</a></h3><ul><li><p><a href="https://ryantm.github.io/nixpkgs/builders/special/fhs-environments/" target="_blank" rel="noreferrer">buildFHSEnv</a></p><p>You may recall this is how I got gambas working. Because it is not a <em>requirement</em> for an <code>*nix</code> operating-system to have <code>/usr/lib/...</code> - yet a lot of applications assume that it (and similar paths) will exist - this is a very convenient tool for wrapping those programs so that they can still execute.</p></li><li><p><code>overrideAttrs</code> and <a href="https://ryantm.github.io/nixpkgs/using/overrides/" target="_blank" rel="noreferrer">overriding in general</a></p><p>Sandaru used this beautifully to bring in <code>gm2</code> from the already-heavily-configured <a href="https://github.com/NixOS/nixpkgs/blob/nixos-25.11/pkgs/build-support/cc-wrapper/default.nix#L1001" target="_blank" rel="noreferrer">gcc package</a>.</p><p>This quite trivially solved a very complex problem: How to build a very large and complex package? Luckily, in the case of such a popular package, as we&#39;ve seen, there&#39;s a very good chance it&#39;s already in nixpkgs!</p></li><li><p>If something doesn&#39;t work, check another version on <a href="https://github.com/NixOS/nixpkgs" target="_blank" rel="noreferrer">nixpkgs</a></p><p>Often, if something in whatever commit/branch of nixpkgs you&#39;ve decided to use doesn&#39;t work, you may find it works in a more recent or older version.</p><p>This was true here for Swift.</p><p>Luckily, it&#39;s a very simple matter to just try a different version; by adding a new flake input: <code>nixpkgs2505.url = &quot;github:nixos/nixpkgs/nixos-25.05&quot;;</code>. In this way you can try any commit you like!</p></li><li><p>Parallel builds</p><p>This is perhaps minor, but useful to remember: in your derivations you can set <code>enableParallelBuilding</code> which will then allow Nix to ... build whatever it can in parallel. Depending on your computer, this can <em>wildly</em> speed up your iteration process!</p></li><li><p>Patching is amazing ‚ù§Ô∏è</p><p>the <code>mkDerivation</code> function allows you to supply a list of patches (i.e. <code>git diff ...</code> outputs) that it can apply to the source tree. This is a very convenient strategy for quickly getting a build that works. In this particular process, it was important to be making progress; so my technique was to patch wildly, and then go back and refine the patch (in almost all cases entirely replace it with <code>sed</code>-style replacements) once the entire build was complete.</p><p>This is a nice incremental-kind of refactoring that keeps you productive and pragmatic, but allows room for precision when you need it.</p></li><li><p>Open source is amazing!</p><p>In fact, quite clearly, patching would be very hard if the code wasn&#39;t open-source. Even though I&#39;ve worked as a programmer for over 25 years now, I still found myself amazed at how useful it was to be able to see and change the code to get it to work, even say 10 or 15 years after it was originally released. Amazing.</p></li><li><p>Monorepo&#39;s can be frustrating</p><p>Of course monorepos are controversial, and they can be both extremely pragmatic and productive. Myself personally I&#39;m open-minded.</p><p>But, while hacking on this I noticed that, if you just want <em>part</em> of a monorepo, they can be extremely inconvenient; because, unless it&#39;s done <em>extremely well</em>, as an external consumer, you need to take into your head the whole structure of all the parts you <em>don&#39;t</em> care about; i.e. you need to work out what depends on what, and how to exclude the things you don&#39;t care about.</p><p>This, at least, was <em>not</em> an aspect of monorepo&#39;s that I had personally previously considered.</p></li><li><p>Why use stable nixpkgs?</p><p>One thing that occured to me recently is that, when working on many projects (or perhaps your company has 100s of repositories), it pays off big to use a stable input for <code>nixpkgs</code>; i.e. <code>nixpkgs.url = &quot;github:nixos/nixpkgs/nixos-25.11</code>. This allows for the most re-use of build outputs between all your various projects.</p></li><li><p><a href="https://bmcgee.ie/posts/2023/02/nix-what-are-fixed-output-derivations-and-why-use-them/" target="_blank" rel="noreferrer">Fixed-output derivations</a> (FODs) can be useful</p><p>A typical Nix derivation cannot access the internet; this is because the goal is reproducibility, and any kind of internet access could result in a difference next time.</p><p>But what if you need to access the internet? To download a package? (or even just source code?! which we do all the time.)</p><p>The solution to this is simple and elegant: just declare the hash of the contents you are expecting to receive! Nix then permits the derivation to access the network, but will error out if the resulting hash doesn&#39;t match.</p><p>This is useful for package managers that don&#39;t allow you to disable checks to the internet; or for packaging steps that require downloading some dependencies.</p></li></ul><h3 id="the-code" tabindex="-1">The code <a class="header-anchor" href="#the-code" aria-label="Permalink to &quot;The code&quot;">‚Äã</a></h3><p>My changes are easiest to browse here: <a href="https://github.com/silky/quine-relay/pull/1" target="_blank" rel="noreferrer">silky/quine-relay/pull/1</a>.</p><p>If you prefer, you can just run it like so:</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes min-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">nix</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> build</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> github:silky/quine-relay/nix</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Then you will find all the source files in <code>./result</code>.</p><p>Perhaps the most fun, at least for me personally, was to see what the resulting <a href="https://esolangs.org/wiki/Piet" target="_blank" rel="noreferrer">piet program</a> looks like (check `QR.png.)</p></div></div></main><footer class="VPDocFooter" data-v-4e39c852 data-v-b4b63abf><!--[--><!--]--><!----><nav class="prev-next" data-v-b4b63abf><div class="pager" data-v-b4b63abf><a class="VPLink link pager-link prev" href="/articles/get-started-nix-flakes.html" data-v-b4b63abf><!--[--><span class="desc" data-v-b4b63abf>Previous page</span><span class="title" data-v-b4b63abf>Getting started with Nix (and Flakes)</span><!--]--></a></div><div class="pager" data-v-b4b63abf><!----></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-9d8abc1e data-v-566314d4><div class="container" data-v-566314d4><p class="message" data-v-566314d4>Built with love ‚ù§Ô∏è on our one and only planet üåç :)</p><!----></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"faqs.md\":\"JpYf2gzV\",\"articles_packaging-128-programming-languages-with-nix.md\":\"sje4CVhI\",\"articles.md\":\"SyGil83v\",\"index.md\":\"7Ga0ayJQ\",\"templates_index.md\":\"5QKPYadQ\",\"articles_why-should-my-project-adopt-nix.md\":\"rkw9tVW5\",\"articles_get-started-nix-flakes.md\":\"qejKtsgy\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Invariant Club\",\"description\":\"Reaching development nirvana through Nix\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"outline\":\"deep\",\"search\":{\"provider\":\"local\",\"options\":{\"disableDetailedView\":true,\"disableQueryPersistence\":true}},\"nav\":[{\"text\":\"Articles\",\"link\":\"/articles\"},{\"text\":\"Templates\",\"link\":\"/templates/\"},{\"text\":\"FAQs\",\"link\":\"/faqs\"}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/InvariantClub/\"}],\"sidebar\":{\"/articles\":[{\"text\":\"Resources\",\"items\":[{\"text\":\"Articles\",\"link\":\"/articles\"},{\"text\":\"Templates\",\"link\":\"/templates/\"},{\"text\":\"FAQs\",\"link\":\"/faqs\"}]}],\"/templates/\":[{\"text\":\"Resources\",\"items\":[{\"text\":\"Articles\",\"link\":\"/articles\"},{\"text\":\"Templates\",\"link\":\"/templates/\"},{\"text\":\"FAQs\",\"link\":\"/faqs\"}]}],\"/faqs\":[{\"text\":\"Resources\",\"items\":[{\"text\":\"Articles\",\"link\":\"/articles\"},{\"text\":\"Templates\",\"link\":\"/templates/\"},{\"text\":\"FAQs\",\"link\":\"/faqs\"}]}]},\"footer\":{\"message\":\"Built with love ‚ù§Ô∏è on our one and only planet üåç :)\"},\"lastUpdated\":false,\"lastUpdatedText\":\"Updated on\"},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>