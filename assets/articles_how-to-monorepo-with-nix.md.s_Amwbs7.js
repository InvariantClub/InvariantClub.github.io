import{_ as i,D as s,c as t,I as e,U as l,o as p}from"./chunks/framework.ALnBf2yK.js";const y=JSON.parse('{"title":"How to monorepo with Nix","description":"","frontmatter":{"title":"How to monorepo with Nix","author":"Noon van der Silk","date":"2026-02-18T00:00:00.000Z","prev":{"text":"Packaging 128 languages with Nix","link":"/articles/packaging-128-programming-languages-with-nix"},"next":false},"headers":[],"relativePath":"articles/how-to-monorepo-with-nix.md","filePath":"articles/how-to-monorepo-with-nix.md"}'),o={name:"articles/how-to-monorepo-with-nix.md"},r=l(`<h2 id="you-are-standing-in-a-monorepo" tabindex="-1">You are standing in a monorepo ... <a class="header-anchor" href="#you-are-standing-in-a-monorepo" aria-label="Permalink to &quot;You are standing in a monorepo ...&quot;">â€‹</a></h2><div class="language-txt vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes min-light nord vp-code"><code><span class="line"><span>You&#39;ve read all the articles. You&#39;ve discussed it at length and from all</span></span>
<span class="line"><span>angles. You&#39;ve considered all the tradeoffs. You&#39;ve created the repo and</span></span>
<span class="line"><span>you&#39;re ready to hack ...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&gt; look around</span></span>
<span class="line"><span></span></span>
<span class="line"><span>You feel comfortable surrounded by all the code you will need to achieve</span></span>
<span class="line"><span>your dream. To the left you see a cosy JavaScript project. To your right</span></span>
<span class="line"><span>you see one or more backend codebases. Directly ahead of you are various</span></span>
<span class="line"><span>docker files ready to run all the services you care about.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>You are, of course, standing in a monorepo.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>What do you want to do next?</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&gt; ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>Perhaps you would like to ...</p><ul><li><em>Run</em> something?</li><li><em>Test</em> something?</li><li><em>Demo</em> something?</li><li><em>Build</em> something?</li><li><em>Fix</em> something?</li><li><em>Break</em> something?!</li></ul><p>Whichever it is, you almost certainly need all of the dependencies of the projects installed and ready to go; at the right version for each project; potentially even with conflicting dependencies, depending on how the lifetime of the particular sub project.</p><p>So, with excitement in our body and optimism in our hearts, let&#39;s get into it.</p><h2 id="nixing-the-monorepo" tabindex="-1">Nixing the monorepo <a class="header-anchor" href="#nixing-the-monorepo" aria-label="Permalink to &quot;Nixing the monorepo&quot;">â€‹</a></h2><h3 id="the-setup" tabindex="-1">The setup <a class="header-anchor" href="#the-setup" aria-label="Permalink to &quot;The setup&quot;">â€‹</a></h3><p>Your particular codebase may differ in languages; but for the purposes of exploring the idea, let&#39;s go with a concrete setup:</p><ol><li>A vuejs-based JavaScript frontend,</li><li>A python project for some data analysis,</li><li>A rust backend,</li><li>A docker-compose file for some database services.</li></ol><p>The scheme will work for however rich an environment you choose to make.</p><h3 id="choices" tabindex="-1">Choices <a class="header-anchor" href="#choices" aria-label="Permalink to &quot;Choices&quot;">â€‹</a></h3><p>Given we&#39;ve agreed to use Nix, we know we&#39;ll be following a <a href="/articles/get-started-nix-flakes.html">flake.nix-style</a> setup.</p><p>But, how should we structure it? It might at first seem obvious to just go with a single big <code>flake.nix</code> file; but we should at least look at the other options:</p><table><thead><tr><th></th><th>1ï¸âƒ£ Single flake.nix</th><th>2ï¸âƒ£ Multiple flake.nix&#39;s</th></tr></thead><tbody><tr><td>ğŸš <strong>Single devShell</strong></td><td>Simple?</td><td>???</td></tr><tr><td>ğŸš ğŸš <strong>Multiple devShells</strong></td><td>Confusing?</td><td>Natural?</td></tr></tbody></table><p>Let&#39;s explore the pros and cons a little bit.</p><ol><li><p>1ï¸âƒ£ ğŸš â€” <strong>Single flake.nix / Single devShell</strong></p><p>This is the most natural idea; especially if you are starting from not having Nix at all. In our example world, we would add nodejs, ruby, python, rust, ... all at once.</p><p><em>Pros:</em></p><ul><li>Simple</li><li>Clear</li><li>Easily run anything at any time</li><li>Shared configuration is easy</li><li>Access to any tool at any time</li><li>Interdependencies easy to express</li></ul><p><em>Cons:</em></p><ul><li>Potential overhead if you never touch certain areas</li><li>Potential for conflict between changes of disconnected areas</li><li>Harder to isolate review requirements</li></ul></li><li><p>2ï¸âƒ£ ğŸš ğŸš â€” <strong>Multiple flake.nix&#39;s / Multiple devShells</strong></p><p>At the other end of the spectrum, if you consider a monorepo as &quot;merely&quot; a place where you put all your (perhaps indepenent) projects, then this idea is very natural: Just consider each project independently; and define the necessary dependencies.</p><p>In our setup, we have maybe ~5 &quot;base&quot; folders; so we could have one <code>flake.nix</code> for each.</p><p><em>Pros</em>:</p><ul><li>Simple</li><li>Best possible isolation: fast hacking, no overlap problems, etc</li><li>&quot;Reversible&quot;</li></ul><p><em>Cons</em>:</p><ul><li>Lose ability to easily interact with other components</li><li>Potentially lots of redundancy</li></ul></li><li><p>2ï¸âƒ£ ğŸš â€” <strong>Multiple flake.nix&#39;s / Single devShell</strong></p><p>While one <em>could</em> do this, I&#39;m just going to immediately rule it out as not particularly interesting because we can basically interpret it as the same idea as above, but arbitrarily definine one extra top-level flake.nix and a mega devShell.</p></li><li><p>1ï¸âƒ£ ğŸš ğŸš â€” <strong>Single flake.nix / Multiple devShells</strong></p><div class="info custom-block"><p class="custom-block-title">Spoiler</p><p>I&#39;m going to argue for this one. But note that the first two options above are very legitimate; and there&#39;s nothing really wrong with picking them. This one just lets us explore something new, so it&#39;s why we will spend most of our time here!</p></div><p>The idea here would be to define a single top-level <code>flake.nix</code>, but design it in a way for maximum seperation, while allowing re-use. This means potentially a couple of devShells, some conveniences to make sure you always have what you need; but enough isolation to avoid conflicts with changes that you don&#39;t care about at the present moment.</p><p><em>Pros</em>:</p><ul><li>Isolation</li><li>Convenience</li><li>Interdependence</li><li>Freedom to hack where you need</li></ul><p><em>Cons</em>:</p><ul><li>Interdependence</li><li>Not breaking it becomes very important</li><li><em>Can</em> incur overhead</li></ul></li></ol><h2 id="what-it-looks-like" tabindex="-1">What it looks like <a class="header-anchor" href="#what-it-looks-like" aria-label="Permalink to &quot;What it looks like&quot;">â€‹</a></h2><p>If you want to jump straight to the code: <a href="https://github.com/InvariantClub/monorepo-with-nix" target="_blank" rel="noreferrer">InvariantClub/monorepo-with-nix</a>.</p><p>We&#39;ve got the following rough structure (excluding a bunch of busywork files):</p><div class="language-txt vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes min-light nord vp-code"><code><span class="line"><span>.</span></span>
<span class="line"><span>â”œâ”€â”€ analytics</span></span>
<span class="line"><span>â”‚Â Â  â”œâ”€â”€ analytics_stuff</span></span>
<span class="line"><span>â”‚Â Â  â”‚Â Â  â””â”€â”€ main.py</span></span>
<span class="line"><span>â”‚Â Â  â”œâ”€â”€ nix</span></span>
<span class="line"><span>â”‚Â Â  â”‚Â Â  â””â”€â”€ outputs.nix</span></span>
<span class="line"><span>â”‚Â Â  â”œâ”€â”€ pyproject.toml</span></span>
<span class="line"><span>â”‚Â Â  â””â”€â”€ uv.lock</span></span>
<span class="line"><span>â”œâ”€â”€ backend</span></span>
<span class="line"><span>â”‚Â Â  â”œâ”€â”€ nix</span></span>
<span class="line"><span>â”‚Â Â  â”‚Â Â  â””â”€â”€ outputs.nix</span></span>
<span class="line"><span>â”‚Â Â  â”œâ”€â”€ Cargo.toml</span></span>
<span class="line"><span>â”‚Â Â  â””â”€â”€ ...</span></span>
<span class="line"><span>â”œâ”€â”€ flake.nix</span></span>
<span class="line"><span>â”œâ”€â”€ frontend</span></span>
<span class="line"><span>â”‚Â Â  â”œâ”€â”€ nix</span></span>
<span class="line"><span>â”‚Â Â  â”‚Â Â  â””â”€â”€ outputs.nix</span></span>
<span class="line"><span>â”‚Â Â  â”œâ”€â”€ package.json</span></span>
<span class="line"><span>â”‚Â Â  â”œâ”€â”€ ...</span></span>
<span class="line"><span>â”œâ”€â”€ infra</span></span>
<span class="line"><span>â”‚Â Â  â”œâ”€â”€ docker-compose.yaml</span></span>
<span class="line"><span>â”‚Â Â  â””â”€â”€ nix</span></span>
<span class="line"><span>â”‚Â Â      â””â”€â”€ outputs.nix</span></span>
<span class="line"><span>â”œâ”€â”€ nix</span></span>
<span class="line"><span>â”‚Â Â  â”œâ”€â”€ formatting.nix</span></span>
<span class="line"><span>â”‚Â Â  â”œâ”€â”€ pkgs.nix</span></span>
<span class="line"><span>â”‚Â Â  â””â”€â”€ serve.nix</span></span>
<span class="line"><span>â””â”€â”€ flake.nix</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>The contents is the following:</p><ul><li><code>./analytics</code>: A uv-based Python project.</li><li><code>./backend</code>: A simple Rust webserver backend (via <a href="https://docs.rs/warp/latest/warp/" target="_blank" rel="noreferrer">warp</a>) with a Cargo.toml</li><li><code>./frontend</code>: A vite-based vuejs frontend</li><li><code>./infra</code>: Docker-based setup</li><li><code>./nix</code>: Project-wide Nix derivations</li></ul><p>In such sub-folder, we also have a <code>./nix</code> folder that gets referrenced in the single top-level <code>flake.nix</code>. This folder defines all the &quot;outputs&quot; for that specific component; i.e. perhaps a <code>package</code> or a <code>devShell</code>.</p><p>For the first three, the <code>outputs.nix</code> is basically exactly what you see in the <code>./nix</code> folder of the respective templates: <a href="https://github.com/InvariantClub/nix-python-uv" target="_blank" rel="noreferrer">nix-python-uv</a>, <a href="https://github.com/InvariantClub/nix-rust" target="_blank" rel="noreferrer">nix-rust</a>, <a href="https://github.com/InvariantClub/nix-js-simple" target="_blank" rel="noreferrer">nix-javascript</a>.</p><p>The more interesting situation happens when you want interdependencies between the projects; so let&#39;s see an example.</p><h3 id="the-frontend-requires-the-backend" tabindex="-1">The frontend requires the backend <a class="header-anchor" href="#the-frontend-requires-the-backend" aria-label="Permalink to &quot;The frontend requires the backend&quot;">â€‹</a></h3><p>It&#39;s pretty natural that the frontend of your app will, at some point, wish to talk to the backend.</p><p>Let&#39;s see the options here.</p><h4 id="option-0-no-backend" tabindex="-1">Option 0. No backend <a class="header-anchor" href="#option-0-no-backend" aria-label="Permalink to &quot;Option 0. No backend&quot;">â€‹</a></h4><p>Probably your app needs to handle when there&#39;s no backend at all. This would just be jumping into the <code>frontend</code> folder and simply running:</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes min-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">npm</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> run</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> dev</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>You&#39;ll perhaps have some errors</p><h4 id="option-1-backend-running-inside-the-devshell" tabindex="-1">Option 1. Backend running <em>inside</em> the devShell <a class="header-anchor" href="#option-1-backend-running-inside-the-devshell" aria-label="Permalink to &quot;Option 1. Backend running _inside_ the devShell&quot;">â€‹</a></h4><ol><li><code>cd backend &amp;&amp; cargo run</code></li><li><code>cd frontend &amp;&amp; npm run dev</code> ...</li></ol><p>This is natural. You run the backend first in some terminal, then you run the frontend.</p><p>This is especially convenient if you&#39;re iterating on both at the same time; but perhaps is a little bit annoying if you <em>just</em> want to iterate on the frontend. It also becomes quadratically more annoying if you have more than one service to coordinate. You need to make sure that everything matches up (with environment variables, etc.)</p><p>So, this remains possible here, but is only recommended when specifically hacking on both services.</p><h4 id="option-2-use-process-compose" tabindex="-1">Option 2. Use <a href="https://github.com/F1bonacc1/process-compose" target="_blank" rel="noreferrer">process-compose</a> <a class="header-anchor" href="#option-2-use-process-compose" aria-label="Permalink to &quot;Option 2. Use [process-compose](https://github.com/F1bonacc1/process-compose)&quot;">â€‹</a></h4><p>We&#39;ve defined <a href="https://github.com/InvariantClub/monorepo-with-nix/blob/main/nix/serve.nix#L26" target="_blank" rel="noreferrer">process-compose</a> setup in <code>serve.nix</code> that runs the backand and frontend together.</p><p>You can run both like:</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes min-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">nix</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> run</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> .#serve</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Or, <em>just</em> the backend like:</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes min-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">nix</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> run</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> .#serve</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> --</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> run</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> backend</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>One advantage here is that, with proper caching, you won&#39;t need to do any rebuilding if you&#39;re not actually hacking on the backend. But perhaps more importantly, it&#39;s typical that any given setup requires <em>many</em> backend services: a database, a queue, etc, etc. These can all be specified in the process-compose style, to make for a very convenient way of spinning up what&#39;s necessary.</p><h4 id="option-3-use-docker-compose" tabindex="-1">Option 3. Use docker compose <a class="header-anchor" href="#option-3-use-docker-compose" aria-label="Permalink to &quot;Option 3. Use docker compose&quot;">â€‹</a></h4><p>A more typical setup would have you use a <code>docker-compose.yaml</code> file that perhaps builds docker images from the source directly; or otherwise obtains images for various services and spins up all (or part) of the environment.</p><p>While this can be effective; unless done in a very careful way, it&#39;s very easy for rebuilds to take a very long time; and depending on your world, you can even forget to rebuild and face annoyances about not using the right version of the image, etc.</p><p>Nevertheless, it can still be very useful to integrate with this style; if only because it allows for gradual adoption.</p><p>For that reason, we provide a docker compose configuration file; but more interestingly, in <code>infra/outputs.nix</code> we provide Nix derivations that <em>actually</em> build docker images!</p><p>The image for the rust backend is so concise that we can repeat it entirely here:</p><div class="language-nix vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">nix</span><pre class="shiki shiki-themes min-light nord vp-code"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;"># ./infra/nix/outputs.nix</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">...</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">packages</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">backend-image</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> pkgs</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">dockerTools</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">streamLayeredImage</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;">  name</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">monorepo-with-nix-</span><span style="--shiki-light:#22863A;--shiki-dark:#81A1C1;">\${</span><span style="--shiki-light:#22863A;--shiki-dark:#D8DEE9;">self&#39;</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">.</span><span style="--shiki-light:#22863A;--shiki-dark:#D8DEE9;">packages</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">.</span><span style="--shiki-light:#22863A;--shiki-dark:#D8DEE9;">backend</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">.</span><span style="--shiki-light:#22863A;--shiki-dark:#D8DEE9;">pname</span><span style="--shiki-light:#22863A;--shiki-dark:#81A1C1;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;">  tag</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">latest</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;">  created</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">now</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;">  contents</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> [</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;"> self&#39;</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">packages</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">backend</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> ]</span><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;">  config</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#8FBCBB;">    Entrypoint</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> [</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;"> &quot;</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;">backend</span><span style="--shiki-light:#22863A;--shiki-dark:#ECEFF4;">&quot;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;"> ]</span><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">  }</span><span style="--shiki-light:#24292EFF;--shiki-dark:#81A1C1;">;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">}</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9;">...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Then, you can build the image with:</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes min-light nord vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;">nix</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> build</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> .#backend-image</span><span style="--shiki-light:#212121;--shiki-dark:#ECEFF4;"> &amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> ./result</span><span style="--shiki-light:#D32F2F;--shiki-dark:#81A1C1;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#88C0D0;"> docker</span><span style="--shiki-light:#2B5581;--shiki-dark:#A3BE8C;"> load</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>In any setting, it&#39;s very useful to have a docker image for whatever you wish to deploy; and here, we use these images directly in the <code>docker-compose.yaml</code> file:</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes min-light nord vp-code"><code><span class="line"><span style="--shiki-light:#C2C3C5;--shiki-dark:#616E88;"># docker-compose.yaml</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#8FBCBB;">services</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#8FBCBB;">  backend</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#8FBCBB;">    image</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;"> monorepo-with-nix-backend</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#8FBCBB;">    ports</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ECEFF4;">:</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ECEFF4;">      -</span><span style="--shiki-light:#22863A;--shiki-dark:#A3BE8C;"> 3030:3030</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D8DEE9FF;">...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>and that&#39;s it! You can interact with this in the normal way you would any docker service. But do not forget to rebuild the image on any code change! Note that the rebuild requirement means this isn&#39;t as joyful as the other three options, but may still be useful to have around to support certain use-cases.</p><h3 id="interdepdenencies" tabindex="-1">Interdepdenencies <a class="header-anchor" href="#interdepdenencies" aria-label="Permalink to &quot;Interdepdenencies&quot;">â€‹</a></h3><p>The main benefit of a unified Nix representation, is how easy it is to express interdependencies. In fact, if the baseline is that your project is already nixified as a flake; it&#39;s actually very easy to do. The only downside is, as is often the case, things become annoying when you&#39;re doing development on all the different places at once.</p><p>Here, this is immediately addressed; because all the definitions are available, and anything that needs to be changed or accessed can be.</p><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to &quot;Conclusion&quot;">â€‹</a></h2><p>Here we&#39;ve presented a concrete example of how to set up a &quot;monorepo&quot; style environment using Nix: <a href="https://github.com/InvariantClub/monorepo-with-nix" target="_blank" rel="noreferrer">InvariantClub/monorepo-with-nix</a>.</p><p>We&#39;ve shown a couple of different other options; and that all have interesting options and drawbacks.</p><p>Hopefully this gives you some food for thought!</p>`,64);function h(c,d,u,k,m,b){const n=s("ArticleHeader"),a=s("ReachOut");return p(),t("div",null,[e(n,{title:"How to monorepo with Nix",author:"Noon van der Silk",image:"noon"}),r,e(a)])}const f=i(o,[["render",h]]);export{y as __pageData,f as default};
